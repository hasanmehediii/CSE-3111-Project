<!DOCTYPE html>
<html>

<head>
    <title>Smart Proxy Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-blue.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</head>

<body class="bg-light text-dark">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar bg-white p-4 shadow-sm">
                <h2 class="mb-4">Proxy Control</h2>

                <!-- Proxy Test Form -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Test Proxy</h5>
                        <form id="proxy-request-form">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="proxy-url" name="url"
                                    placeholder="Enter URL to fetch" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Fetch via Proxy</button>
                        </form>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Configuration</h5>
                        <p><strong>Cache Type:</strong> <span class="badge bg-info">{{ cache_type }}</span></p>
                        <h6>Blacklist:</h6>
                        <ul id="blacklist" class="list-group">
                            {% for domain in blacklist %}
                            <li class="list-group-item">{{ domain }}</li>
                            {% else %}
                            <li class="list-group-item">No domains blacklisted.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Cache Info -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Cache Info</h5>
                        <p>Total Cached URLs: <span class="badge bg-success" id="total-cached">{{ total_cached
                                }}</span></p>
                        <h6>Cached URLs:</h6>
                        <ul id="cached-urls" class="list-group">
                            {% for url in cached_urls %}
                            <li class="list-group-item">
                                <span class="url-cell" title="{{ url }}">{{ url }}</span>
                                <a href="/view?url={{ url }}" class="btn btn-sm btn-outline-primary float-end"
                                    target="_blank">Preview</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content p-4">
                <h1 class="text-center mb-4">Smart Proxy Dashboard</h1>

                <!-- Live Requests Table -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Live Requests</h5>
                        <div class="table-responsive">
                            <table id="requests-table" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Method</th>
                                        <th>URL</th>
                                        <th>Status</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- Proxy Response -->
                <div id="proxy-response-container" class="mt-4 card" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">Proxy Response</h5>
                        <p><strong>Source:</strong> <span id="proxy-status" class="badge"></span></p>
                        <pre><code id="proxy-response" class="language-html"></code></pre>
                        <button id="view-in-new-tab" class="btn btn-info mt-2" style="display: none;">View in new
                            tab</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        async function fetchRequests() {
            try {
                const response = await fetch('/api/requests');
                if (!response.ok) {
                    console.error('Failed to fetch requests');
                    return;
                }
                const requests = await response.json();
                const tableBody = document.querySelector('#requests-table tbody');
                tableBody.innerHTML = ''; // Clear existing rows

                requests.forEach(req => {
                    const row = document.createElement('tr');
                    let sourceBadge;
                    switch (req.source) {
                        case 'cache':
                            sourceBadge = `<span class="badge bg-hit">Cache</span>`;
                            break;
                        case 'origin':
                            sourceBadge = `<span class="badge bg-miss">Origin</span>`;
                            break;
                        case 'blacklist':
                            sourceBadge = `<span class="badge bg-blacklist">Blacklisted</span>`;
                            break;
                        default:
                            sourceBadge = `<span class="badge bg-secondary">${req.source}</span>`;
                    }
                    row.innerHTML = `
                        <td>${formatTimestamp(req.timestamp)}</td>
                        <td>${req.method}</td>
                        <td class="url-cell" title="${req.url}">${req.url}</td>
                        <td>${req.status}</td>
                        <td>${sourceBadge}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching or processing requests:', error);
            }
        }

        // Fetch requests every 2 seconds
        setInterval(fetchRequests, 2000);

        // Initial fetch
        fetchRequests();

        document.getElementById('proxy-request-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const url = document.getElementById('proxy-url').value;
            const responseContainer = document.getElementById('proxy-response-container');
            const responseElement = document.getElementById('proxy-response');
            const statusElement = document.getElementById('proxy-status');
            const newTabButton = document.getElementById('view-in-new-tab');

            responseElement.textContent = 'Fetching...';
            statusElement.textContent = '';
            newTabButton.style.display = 'none';
            responseContainer.style.display = 'block';

            try {
                const response = await fetch('/proxy-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();
                responseElement.textContent = data.content;

                let statusBadge;
                switch (data.status) {
                    case 'cache':
                        statusBadge = `<span class="badge bg-hit">Cache</span>`;
                        break;
                    case 'origin':
                        statusBadge = `<span class="badge bg-miss">Origin</span>`;
                        break;
                    case 'blacklist':
                        statusBadge = `<span class="badge bg-blacklist">Blacklisted</span>`;
                        break;
                    default:
                        statusBadge = `<span class="badge bg-secondary">${data.status}</span>`;
                }
                statusElement.innerHTML = statusBadge;
                hljs.highlightAll();

                if (data.content) {
                    newTabButton.style.display = 'block';
                    newTabButton.onclick = function () {
                        const newWindow = window.open();
                        newWindow.document.write(data.content);
                        newWindow.document.close();
                    }
                }

            } catch (error) {
                responseElement.textContent = 'Error fetching URL.';
                statusElement.innerHTML = `<span class="badge bg-danger">Error</span>`;
                console.error('Error:', error);
            }
        });
    </script>
</body>

</html>