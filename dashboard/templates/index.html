<!DOCTYPE html>
<html>

<head>
    <title>Smart Proxy Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <h1>Smart Proxy Dashboard</h1>

    <div class="container">
        <div class="main-content">
            <h2>Live Requests</h2>
            <table id="requests-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Method</th>
                        <th>URL</th>
                        <th>Status</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="sidebar">
            <div class="proxy-form">
                <h2>Test Proxy</h2>
                <form id="proxy-request-form">
                    <input type="text" id="proxy-url" name="url" placeholder="Enter URL to fetch" required>
                    <button type="submit">Fetch via Proxy</button>
                </form>
                <div id="proxy-response-container">
                    <h3>Proxy Response:</h3>
                    <pre><code id="proxy-response" class="language-html"></code></pre>
                    <button id="view-in-new-tab" style="display: none;">View in new tab</button>
                    <p><strong>Source:</strong> <span id="proxy-status"></span></p>
                </div>
            </div>
            <h2>Configuration</h2>
            <p><strong>Cache Type:</strong> {{ cache_type }}</p>

            <h3>Blacklist:</h3>
            <ul id="blacklist">
                {% for domain in blacklist %}
                <li>{{ domain }}</li>
                {% else %}
                <li>No domains blacklisted.</li>
                {% endfor %}
            </ul>

            <h2>Cache Info</h2>
            <p>Total Cached URLs: <span id="total-cached">{{ total_cached }}</span></p>

            <h3>Cached URLs:</h3>
            <ul id="cached-urls">
                {% for url in cached_urls %}
                <li>
                    <span class="url-cell" title="{{ url }}">{{ url }}</span> â€”
                    <a href="/view?url={{ url }}" target="_blank">Preview</a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>


    <script>
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        async function fetchRequests() {
            try {
                const response = await fetch('/api/requests');
                if (!response.ok) {
                    console.error('Failed to fetch requests');
                    return;
                }
                const requests = await response.json();
                const tableBody = document.querySelector('#requests-table tbody');
                tableBody.innerHTML = ''; // Clear existing rows

                requests.forEach(req => {
                    const row = document.createElement('tr');
                    if (req.source === 'blacklist') {
                        row.classList.add('blacklisted');
                    }
                    row.innerHTML = `
                        <td>${formatTimestamp(req.timestamp)}</td>
                        <td>${req.method}</td>
                        <td class="url-cell" title="${req.url}">${req.url}</td>
                        <td>${req.status}</td>
                        <td>${req.source}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching or processing requests:', error);
            }
        }

        // Fetch requests every 2 seconds
        setInterval(fetchRequests, 2000);

        // Initial fetch
        fetchRequests();

        document.getElementById('proxy-request-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const url = document.getElementById('proxy-url').value;
            const responseContainer = document.getElementById('proxy-response');
            const statusContainer = document.getElementById('proxy-status');
            const newTabButton = document.getElementById('view-in-new-tab');

            responseContainer.textContent = 'Fetching...';
            statusContainer.textContent = '';
            newTabButton.style.display = 'none';

            try {
                const response = await fetch('/proxy-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();
                responseContainer.textContent = data.content;
                statusContainer.textContent = data.status;
                hljs.highlightAll();
                
                if (data.content) {
                    newTabButton.style.display = 'block';
                    newTabButton.onclick = function() {
                        const newWindow = window.open();
                        newWindow.document.write(data.content);
                        newWindow.document.close();
                    }
                }

            } catch (error) {
                responseContainer.textContent = 'Error fetching URL.';
                statusContainer.textContent = 'Error';
                console.error('Error:', error);
            }
        });
    </script>
</body>

</html>